<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin Candlestick Chart with NEAT AI Optimized Trading Bot</title>
    <script src="lib/lightweight-charts.standalone.production.js"></script>
    <script src="lib/neataptic.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            height: 100vh;
            margin: 0;
            background-color: #f5f5f5;
        }

        #chart {
            width: 80%;
            height: 500px;
        }
    </style>
</head>
<body>
    <div id="chart"></div>
    <div>
        <p>Bot Balance: <span id="balance">$10000</span></p>
        <p>Bitcoin Owned: <span id="bitcoinOwned">0 BTC</span></p>
        <p>Best Genome Fitness: <span id="bestFitness">0</span></p>
    </div>
    <script>
        // Tạo biểu đồ Lightweight Charts
        const chart = LightweightCharts.createChart(document.getElementById('chart'), {
            width: document.body.clientWidth * 0.8,
            height: 500,
            layout: {
                backgroundColor: '#ffffff',
                textColor: '#000000',
            },
            grid: {
                vertLines: {
                    color: '#e1e1e1',
                },
                horzLines: {
                    color: '#e1e1e1',
                },
            },
            crosshair: {
                mode: LightweightCharts.CrosshairMode.Normal,
            },
            rightPriceScale: {
                borderColor: '#d1d4dc',
            },
            timeScale: {
                borderColor: '#d1d4dc',
                timeVisible: true,
            },
        });

        const candlestickSeries = chart.addCandlestickSeries();
        let data = [];

        // Số lượng bot giao dịch
        const NUM_BOTS = 10;

        // Tạo các bot với NEAT
        const neat = new neataptic.Neat(6, 2, null, {
            populationSize: NUM_BOTS,
            mutationRate: 0.3,
            elitism: 5,
            network: new neataptic.architect.Perceptron(6, 10, 2) // 6 input, 10 hidden, 2 output
        });

        // Khởi tạo trạng thái của 10 bot
        let botStates = Array(NUM_BOTS).fill().map(() => ({
            balance: 10000,   // Số dư của bot
            bitcoinOwned: 0,  // Số BTC nắm giữ
            lastPrice: null,  // Giá cuối cùng của BTC
            purchasePrice: null,  // Lưu giá mua để chốt lời
            fitness: 0        // Điểm fitness của bot
        }));

        let bestFitness = 0;
        let bestGenome = null;
        let markers = [];  // Lưu các điểm giao dịch trên biểu đồ

        // Cập nhật số dư và lượng BTC nắm giữ của bot trên giao diện
        function updateBotInfo(botIndex) {
            document.getElementById('balance').textContent = `$${botStates[botIndex].balance.toFixed(2)}`;
            document.getElementById('bitcoinOwned').textContent = `${botStates[botIndex].bitcoinOwned.toFixed(4)} BTC`;
            document.getElementById('bestFitness').textContent = `${bestFitness.toFixed(2)}`;
        }

        // Tính SMA (Simple Moving Average)
        function calculateSMA(data, period) {
            if (data.length < period) {
                return null; // Không đủ dữ liệu để tính SMA
            }

            let sum = 0;
            for (let i = data.length - period; i < data.length; i++) {
                sum += data[i].close;
            }
            return sum / period;
        }

        // Hàm ra quyết định giao dịch của từng bot
        function botTradeDecision(input, sma, botIndex) {
            const bot = neat.population[botIndex];
            const outputs = bot.activate(input);  // Sử dụng genome của bot hiện tại
            const decision = outputs[0];  // Lấy quyết định từ bot (sử dụng đầu ra đầu tiên)

            const cashRatio = botStates[botIndex].balance / (botStates[botIndex].balance + botStates[botIndex].bitcoinOwned * lastPrice); // Tỷ lệ tiền mặt/tổng tài sản

            // Chốt lời nếu giá hiện tại tăng 1% so với giá mua ban đầu
            if (botStates[botIndex].purchasePrice !== null && lastPrice >= botStates[botIndex].purchasePrice * 1.01) {
                return 'sell';  // Bán nếu đạt mục tiêu lợi nhuận 1%
            }

            if (cashRatio < 0.15) {
                return 'hold';  // Giữ nếu tiền mặt dưới 15%
            } else if (cashRatio > 0.35) {
                return 'buy';  // Tìm cơ hội mua nếu tiền mặt trên 35%
            } else if (lastPrice > sma) {
                return 'buy';  // Mua nếu giá vượt qua SMA
            } else if (lastPrice < sma) {
                return 'sell';  // Bán nếu giá dưới SMA
            } else if (outputs[0] > 0.6) {
                return 'buy';  // Quyết định mua nếu AI đưa ra tín hiệu mạnh
            } else if (outputs[0] < 0.4) {
                return 'sell';  // Quyết định bán nếu AI đưa ra tín hiệu bán mạnh
            } else {
                return 'stand-out';  // Không giao dịch
            }
        }

        // Đánh giá fitness của mỗi bot
        function evaluateFitness(botIndex) {
            const botState = botStates[botIndex];
            botState.fitness = (botState.bitcoinOwned * lastPrice) + botState.balance;  // Tổng tài sản (BTC + tiền mặt)
            return botState.fitness;
        }

        // Tìm genome tốt nhất sau mỗi thế hệ
        function findBestGenome() {
            for (let i = 0; i < NUM_BOTS; i++) {
                const fitness = evaluateFitness(i);
                neat.population[i].score = fitness;  // Cập nhật điểm fitness cho genome của bot

                if (fitness > bestFitness) {
                    bestFitness = fitness;
                    bestGenome = neat.population[i];
                    console.log("New best genome found with fitness:", bestFitness);
                }
            }
        }

        // Kết nối WebSocket và xử lý dữ liệu nến
        const socket = new WebSocket(`ws://${window.location.host}`);

        socket.onmessage = function (event) {
            const message = JSON.parse(event.data);

            if (message.open && message.high && message.low && message.close) {
                const time = Math.floor(message.time / 1000); // Chuyển đổi timestamp thành giây

                // Thêm dữ liệu candlestick vào biểu đồ
                data.push({
                    time: time,
                    open: message.open,
                    high: message.high,
                    low: message.low,
                    close: message.close
                });

                candlestickSeries.setData(data);

                // Bot xử lý với dữ liệu nến mới
                lastPrice = message.close;

                // Tính SMA cho 20 nến gần nhất
                const sma20 = calculateSMA(data, 20);

                for (let i = 0; i < NUM_BOTS; i++) {
                    // Đầu vào cho bot là giá mở, cao, thấp, đóng, số dư và lượng BTC nắm giữ
                    const input = [
                        message.open / 10000,  // Chuẩn hóa đầu vào
                        message.high / 10000,
                        message.low / 10000,
                        message.close / 10000,
                        botStates[i].balance / 10000,  // Chuẩn hóa số dư
                        botStates[i].bitcoinOwned / 10  // Chuẩn hóa lượng BTC
                    ];

                    // Ra quyết định cho từng bot
                    const decision = botTradeDecision(input, sma20, i);

                    if (decision === 'buy' && botStates[i].balance > 0) {
                        // Bot mua 1% số dư của nó
                        const buyAmountInUSD = botStates[i].balance * 0.01;  // 1% số dư
                        const buyAmountInBTC = buyAmountInUSD / message.close;  // Lượng BTC mua được
                        botStates[i].bitcoinOwned += buyAmountInBTC;
                        botStates[i].balance -= buyAmountInUSD;  // Trừ đi số tiền đã mua

                        // Lưu giá mua
                        botStates[i].purchasePrice = message.close;

                        // Đánh dấu điểm mua trên biểu đồ
                        markers.push({
                            time: time,
                            position: 'belowBar',
                            color: 'green',
                            shape: 'arrowUp',
                            text: `Buy ${buyAmountInBTC.toFixed(4)} BTC`
                        });

                        console.log(`Bot ${i} mua ${buyAmountInBTC.toFixed(4)} BTC với giá ${message.close}`);
                    } else if (decision === 'sell' && botStates[i].bitcoinOwned > 0) {
                        // Bot bán toàn bộ lượng Bitcoin mà nó đang sở hữu
                        const sellAmountInUSD = botStates[i].bitcoinOwned * message.close;  // Giá trị Bitcoin sở hữu khi bán
                        botStates[i].balance += sellAmountInUSD;
                        botStates[i].bitcoinOwned = 0;  // Sau khi bán thì không còn Bitcoin

                        // Xóa giá mua sau khi bán
                        botStates[i].purchasePrice = null;

                        // Đánh dấu điểm bán trên biểu đồ
                        markers.push({
                            time: time,
                            position: 'aboveBar',
                            color: 'red',
                            shape: 'arrowDown',
                            text: `Sell ${sellAmountInUSD.toFixed(2)} USD`
                        });

                        console.log(`Bot ${i} bán Bitcoin với giá ${message.close}`);
                    } else if (decision === 'hold') {
                        console.log(`Bot ${i} quyết định giữ (hold) - không thực hiện giao dịch.`);
                    } else if (decision === 'stand-out') {
                        console.log(`Bot ${i} quyết định đứng ngoài (stand-out) - không thực hiện giao dịch.`);
                    }
                }

                // Cập nhật các markers trên biểu đồ sau khi giao dịch
                candlestickSeries.setMarkers(markers);

                // Tìm genome tốt nhất sau khi tất cả các bot thực hiện giao dịch
                findBestGenome();
            }
        };

        // Sau mỗi thế hệ (khi tất cả các bot đã giao dịch), thực hiện quá trình đột biến và tạo thế hệ mới
        neat.generation();

        // Nút để lưu genome tốt nhất
        const saveButton = document.createElement('button');
        saveButton.innerText = 'Save Best Genome';
        saveButton.onclick = function saveBestGenome() {
            if (bestGenome) {
                const blob = new Blob([JSON.stringify(bestGenome.toJSON())], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'best_genome.json';
                a.click();
                URL.revokeObjectURL(url);
            }
        };
        document.body.appendChild(saveButton);
    </script>
</body>
</html>
